<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>node-web-console-lite</title>
    <style>
    html,body{margin:0;padding:0;}
    #term{width:100%;position:fixed;top:0;left:0;height:30px;}
    .cmd{color:red;}
    #result{margin-top:35px;padding-left:10px;}
    </style>
</head>
<body>
<input type="text" list="cmds" id="term">
<datalist id="cmds"></datalist>
<div id="result">
</div>
<script>
    var macros = {
        a:'echo a',
        b:()=>'echo b',
        c:x=>`echo c,${x}`,
        speak:(...x)=>`speak -t "${x.join(' ')}"`,// 只能说英语,声音大
        ps:x=>`tasklist /fi "imagename eq ${x}.exe"`,
        kill:x=> `taskkill /f /im ${x}.exe`,
        speaks:(...x)=>`nircmdc speak -t "${x.join(' ')}"`, // 说中文,声音略小
    };
var _cmds = '';
for(var key in macros){
    var opt = `<option value="${key}: ${macros[key].toString().replace(/\"/g,`'`)}" />`;
    _cmds += opt;
}
cmds.innerHTML += _cmds;
    term.focus();
term.onkeydown=function(event){
    if(event.keyCode == 13){
        var _cmd = this.value.trim();
        if(_cmd == '') return;

        var _cmdarr = _cmd.split(' ');
//        var _timeout = _cmdarr[0] === '1' ? +_cmdarr.shift() : 0;
        var _q = _cmdarr[0],
            _args = _cmdarr.slice(1);
        if(typeof macros[_q] == 'string') {
            _cmd = macros[_q]
        }
        if(typeof macros[_q] == 'function'){
            _cmd = macros[_q](..._args);
        }
        var d = {
            cmd:_cmd,
        /*    timeout: _timeout*/
        };

        var _opt = `<option value="${_cmd}" />`;
        cmds.innerHTML += _opt;

        this.value = '';

        fetch('/rpc',{
            method:'POST',
            mode:'cors',
            body:JSON.stringify(d),
            headers:{
                'content-type':'application/json'
            }
        }).then(d=>d.json())
            .then(res=>{
                var template = `
    <div class="result">
        <div class="stdin">
            <span class="cwd">${res.cwd}&gt;</span>
            <span class="cmd">${res.cmd}</span></div>
        <pre class="stdout">${res.res.replace(/<DIR>/g,'[DIR]')}</pre>
        <dir class="time">${res.time}</dir>
    </div>`;
                result.innerHTML+=template;
                document.documentElement.scrollTo(0,document.body.scrollHeight);
            })
    }
}
</script>
</body>
</html>
